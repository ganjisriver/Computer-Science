# 03. 교착 상태 해결 방법

### 1. 교착 상태 해결

교착 상태를 해결 하는 방법은 예방, 회피, 검출이며, 이후 교착 상태가 발견된 후에 자원을 회복 하는 방법도 있다.

- **교착 상태 예방**
  - 교착 상태를 유발하는 네 가지 조건이 발생하지 않도록 무력화하는 방식이다.
  - 교착 상태는 상호배제, 비선점, 점유와 대기, 원형 대기라는 네 가지 조건을 동시에 충족해야 발생하기 때문에, 이 중 하나라도 막는다면 교착 상태가 발생하지 않는다.
  - 하지만 이 방법은 실효성이 적어 잘 사용되지 않는다.
- 교착 상태 회피
  - 자원 할당량을 조절하여 교착 상태를 해결하는 방식이다.
  - 자원 할당 중 교착 상태를 유발할 가능성이 있다고 판단되면 자원 할당을 중단하고 지켜보는 것이다.
  - 그러나 자원을 얼마만큼 할당해야 교착 상태가 발생하지 않는다는 보장이 없기 때문에 실효성이 적다.
- 교착 상태 검출과 회복
  - 교착 상태 검출은 어떤 제약을 가하지 않고 자원 할당 그래프를 모니터링하면서 교착 상태가 발생하는지 살펴보는 방식이다.
  - 만약 교착 상태가 발생하면, 교착 상태 회복 단계가 진행된다.
  - 가장 현실적인 접근 방법이다.

### 2. 교착 상태 예방

교착 상태를 유발하는 네 가지 조건 중 하나라도 예방하여 교착 상태를 처리하는 방법으로 다음과 같은 네 가지 예방법이 있다.

`상호 배제 예방`

- 정의
  - 시스템 내에 있는 모든 상호 배타적인 자원을 없애버리는 방법
- 철학자의 식사 문제에서도 모든 포크를 공유할 수 있다면, 교착 상태가 발생하지 않는다. 변수나 파일도 공유하면, 교착 상태가 발생하지 않는다.
- 단점
  - 현실적으로 모든 자원을 공유하는 것은 불가능하다.
  - 임계 구역 문제에서, 임계 구역을 보호하지 않으면 결과값이 달라지는 문제가 발생할 수 있는 등 상호 배제를 무력화하기는 불가능하다.

`비선점 예방`

- 정의
  - 모든 자원을 뺏을 수 있도록 하는 방법
- 단점
  - 상호 배제 예방과 마찬가지로, 임계구역을 보호하기 위해 잠금을 사용할 때, 자원을 뺏을 수 없다.
  - 또한, 자원을 빼앗는 기준을 정하기 어렵다.
  - 아사 현상을 일으킬 수 있어서, 공평성 원리에 위배된다.

`점유와 대기 예방`

- 정의
  - 프로세스가 자원을 점유한 상태에서 다른 자원을 기다리지 못하게 하는 방법
- 단점
  - 프로세스가 자신이 사용하는 모든 자원을 자세히 알기 어렵다.
    - 프로세스가 필요한 자원을 모두 확보한 후 실행했는데, 추가로 필요한 자원이 생기면 이를 다시 확보하기 어려움.
  - 자원의 활용성이 떨어진다.
    - 프로세스가 미래에 사용할 자원까지 선점하기 때문에, 그 자원을 필요로 하는 다른 프로세스의 작업이 진행되지 않는다.
  - 많은 자원을 사용하는 프로세스가 적은 자원을 사용하는 프로세스보다 불리하다.
    - 프로세스가 적은 자원이 당연히 필요한 모든 자원을 확보하기 쉽다. 그렇기 때문에, 많은 자원을 확보 해야하는 프로세스의 아사 현상이 발생할 수 있다.

`원형 대기 에방`

- 정의
  - 점유와 대기를 하는 프로세스들이 원형을 이루지 못하도록 하는 방식
- 단점
  - 프로세스 작업 진행에 유연성이 떨어진다.
    - 작업 대기 상태가, 마우스를 사용한 후, 프린터를 사용하는 형태로 대기가 이루어진다면, 그 역 상태로는 이루어질 수 없기 때문에, 유연성이 떨어진다.
  - 자원의 순서를 정하는 문제
    - 자원의 순서를 어떻게 정하든, 그 역의 상황이 발생하는 문제가 발생하여, 자원 사용에 대한 제약이 따른다.

### 3. 교착 상태 회피

`교착 상태 회피의 개념`

- 정의
  - 프로세스에 자원을 할당할 때, 어느 수준으로 자원을 할당하면, 교착 상태가 발생하는지 파악하여, 그 수준 이하로 할당하는 방식

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/be38ee65-8e96-42ee-8f4b-f97ec9ad388e/Untitled.png)

- 할당된 자원의 수가 많을 수록, 교착 상태가 발생할 가능성이 높기 때문에, 그 수를 조절하는 방식임을 알 수 있다.

`은행원 알고리즘`

- 이름의 유래
  - 은행이 대출해주는 방식은 대출 금액이 가능한 범위이면, 대출해주고, 아니면 대출을 거부하는 방식과 유사하여 붙여진 이름
- 은행원 알고리즘에서의 변수
  - 전체 자원(Total)
    - 시스템 내 전체 자원의 수
  - 가용 자원(Available)
    - 시스템 내 현재 사용 할 수 있는 자원의 수(가용 자원=전체 자원-모든 프로세스의 할당 자원)
  - 최대 자원(Max)
    - 각 프로세스가 선언한 최대 자원의 수
  - 할당 자원(Allocation)
    - 각 프로세스에 현재 할당된 자원의 수
  - 기대 자원(expect)
    - 각 프로세스의 앞으로 사용할 자원의수 (기대자원 = 최대자원 - 할당자원)

`뱅커 알고리즘에서 자원 할당 기준`

- 각 프로세스의 기대 자원과 비교하여 가용 자원이 하나라도 크거나 같으면 자원을 할당(available>=Expect)할당

- 가용 자원이 어떤 기대 자원보다 크지 않으면 할당하지 않음(acailable< expect)
  
  !https://velog.velcdn.com/images%2Fsunil1369%2Fpost%2F7fb02580-b268-4cf0-9d60-dbf4ee029ad7%2Fimage.png

`교착 상태 회피의 문제점`

- **프로세스가 자신이 사용할 모든 자원을 미리 선언해야함**
  - 교착 상태 회피에서는 모든 프로세스가 자신이 사용할 자원을 미리 선언해야 하는데, 이는 쉽지 않다.
- **시스템의 전체 자원수가 고정적이여야함**
  - 교착 상태 회피 방식에서는 전체 자원의 수가 고정적이어야하지만, 컴퓨터의 자원은 항상 유동적으로 변한다.
- **자원이 낭비됨**
  - 사용하지 않는 자원도 미리 할당해야하기 때문에, 자원의 낭비 발생
  - 불안정 상태에서 반드시 교착 상태가 발생하지 않음에도, 자원 사용이 한정되어 있어, 자원의 낭비 발생

### 4. 교착 상태 검출

`타임아웃`

- 정의
  
  - 일정 시간 동안 작업이 진행되지 않은 프로세스를 교착 상태가 발생한 것으로 간주하여 처리하는 방식이다.

- 조건
  
  - 교착 상태가 자주 발생하지 않는 것을 상정함.
  - 가벼운 교착 상태 검출이라고도 부름.

- 예시
  
  - ‘프로그램이 응답하지 않습니다.’ 라는 문구와 함께 프로세스가 종료되는 경우가 타임아웃을 통한 프로세스 제거다.

- 단점
  
  - 엉뚱한 프로세스가 강제 종료될 수 있다.
    
    - 교착 상태 이외의 이유로 작업이 진행되지 못한 프로세스가 종료될 수 있다.
  
  - 모든 시스템에 적용할 수 없다.
    
    - 분산 DB에서는 데이터가 여러 개로 나뉘어있고, 원격지에 있는 프로세스의 응답 없음을 확실하게 알 수 없다.
    - DB에서 타임아웃으로 프로세스를 종료시킨다면, 데이터 일관성을 유지할 수 없다.
    
    → 해결을 위해 체크포인트와 롤백을 사용한다.
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/266d7d86-892f-4e6a-9b2d-6652bb219c7f/Untitled.png)
    
    - 타임아웃에 의해 프로세스를 중단해야 한다면, 롤백을 통해 하드디스크에 저장된 데이터인 스냅숏을 가져와 시스템을 복귀시킨다.

---

`자원 할당 그래프를 이용한 교착 상태 검출`

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/8e781ba5-27a9-46f9-b53a-aba1844e41db/Untitled.png)

- 교착 상태가 없는 자원 할당 그래프
  
  - P1은 P2가 R2를 사용하기를 기다리고, P4는 P1의 자원 반환을, P3는 P4의 자원반환을 기다린다.
  
  → 사이클이 발생하지 않아, 순서대로 작업이 가능하여 교착 상태가 발생하지 않는다.

- 교착 상태가 있는 자원 할당 그래프
  
  - 특징
    - 사이클이 발생하였기 때문에, 교착 상태가 발생한 것으로 운영체제는 판단한다.
    - 단일 자원의 경우 사이클이 있으면, 교착 상태로 판단한다.
    - 다중 자원을 사용하는 경우, 사이클이 있다고 하여 교착 상태라고 판단하지 않는다.
  - 장점
    - 프로세스의 작업 방식을 제한하지 않고, 교착 상태를 정확하게 파악할 수 있다.
  - 단점
    - 교착 상태 검출 파악하기 위한 오버헤드가 발생한다.

### 5. 교착 상태 회복

- 정의
  - 교착 상태가 검출되어 교착 상태를 푸는 후속 작업
  - 교착 상태를 유발한 프로세스를 강제 종료함
- 프로세스를 가제로 종료하는 방법
  - 교착 상태를 일으킨 모든 프로세스를 동시에 종료 한다.
    - 종료된 프로세스들이 동시에 작업을 시작하면 다시 교착 상태를 유발할 가능성이 높다.
    - 이를 방지하기 위해 순차적으로 실행해야 하고, 어떤 프로세스를 먼저 실행해야 할지 기준을 정해야 함.
  - 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료한다.
    - 방식
      - 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료하면서 나머지 프로세스 상태 파악
    - 기준
      - 우선순위가 낮은 프로세스를 먼저 종료한다.
      - 우선순위가 같으면 작업 시간이 짧은 프로세스를 먼저 종료한다.
      - 위의 두 조건이 같으면 자원을 많이 사용하는 프로세스를 먼저 종료한다.
- 교착 상태에 걸린 프로세스를 강제 종료 하기 전 시스템 복구를 해야함.
  - 이 방법은 시스템에 많은 부하를 주기에 체크포인트를 선택적으로 사용해야 한다.
