# 04. 스레드

1. **스레드의 개념**

`스레드의 정의`

- 프로세스의 코드에 정의된 절차에 따라 CPU에 작업 요청을 하는 실행 단위다.
- 프로세스가 생성되면 CPU 스케줄러는 프로세스가 해야할 일을 CPU에 전달한다.

→ 이 때, CPU가 처리하는 작업의 단위는 프로세스로부터 전달받은 스레드가 된다.

운영체제의 작업 단위는 프로세스, CPU의 작업 단위는 스레드라고 볼 수 있다.

- 프로세스와 스레드의 관계에 빗댄 작업의 크기
  - 작업을 상대적인 크기순으로 나열하면 job > task > operation이고, 이를 프로세스와 스레드의 관계에 대입하면, 처리 > 프로세스 > 스레드다.
  - 여러 스레드가 모여 프로세스, 여러 프로세스가 모여 처리가 된다.

`요리에 비유한 프로세스와 스레드의 차이`

- 프로세스
  
  - 주방에 주문이 죽과 안심 스테이크가 들어온다고 했을 때, 죽을 만드는 과정, 안심 스테이크를 만드는 과정이 프로세스다.
  - 위 요리들은 서로에 큰 영향을 미치지 않는다.
  - 손님의 취향에 따라 서빙 순서를 바꿀 수 도 있다.
  
  → 프로세스 간 결합이 약하고, 우선순위에 따라 프로세스 간 순서를 바꿀 수 있음을 의미한다.

- 스레드
  
  - 프로세스는 여러 스레드로 구성되고, 스레드 간 결합이 강하다.
  - 안심 스테이크 굽기라는 프로세스에서 고기 굽기, 채소 굽기, 소스 뿌리기라는 세 가지의 스레드로 구성된다.
  - 먼저 고기와 채소를 굽고 소스를 뿌려야 하는 등 스레드 간 결합도가 강하다.

→ 서로 독립적인 프로세스와 서로 강하게 연결된 스레드의 차이를 응용프로그램에서 볼 수 있다.

- 멀티태스크
  
  - 워드프로세서와 프린터 스풀러는 서로 독립적으로 작동하다가 필요할 때만 출력할 데이터를 주고 받는다.
  - 즉, 워드 프로세서가 비정상적으로 종료되어도, 스풀러는 정상적으로 동작하고, 이는 서로 독립적으로 동작한다.
  - 이렇게, 서로 독립적인 프로세스는 데이터를 주고받을 때 프로세스 간 통신을 이용한다.

- 멀티스레드
  
  - 워드 프로세서 내에는 문서 편집, 문서 입출력, 맞춤법 검사, 그림판 같은 스레드들이 동시에 작업을 한다. 이를 멀티 스레드라고 한다.
  - 이런 스레드들은 서로 강하게 연결되어 있어, 워드 프로세서가 종료되면 프로세스 내의 스레드도 강제 종료 된다.
  - 멀티스레드는 변수나 파일 등을 공유하고 전역 변수나 함수 호출 등의 방법으로 스레드 간 통신을 한다.

이전에는 프로세스 내부 작업 단위를 여러 개로 나누지 않았다. 즉 싱글 스레드의 프로세스 형태로 작업을 했다.

CPU와 프로그래밍 기술이 발전하면서 여러 개의 코어를 가진 CPU가 생겨나 멀티스레드를 지원하였다.

---

2, **멀티스레드의 구조와 예**

`멀티스레드의 구조`

- 여러 개의 작업을 동시에 처리하기 위해 fork()와 exec() 시스템 호출을 통한 작업을 실행했다.
- 하지만, fork()를 사용하면, 데이터, 코드 영역의 일부가 메모리에 중복되어 존재하며, 부모-자식이어도 서로 독립적인 프로세스이므로 낭비 요소를 제거할 수 없다.

→ 스레드는 이러한 멀티태스킹의 낭비 요소를 제거하기 위해 사용된다. 비슷한 일을 하는 2개의 프로세스를 만드는 대신 코드, 데이터 등을 공유하면서 여러 개의 일을 하나의 프로세스 내에서 한다.

![Untitled](C:\Users\ganjisriver\Desktop\git_file\Computer-Science\쉽게%20배우는%20운영체제\3장%20프로세스와%20스레드\assets\3-4-1%20멀티스레드%20구조.png)

위처럼, 같은 정적 영역을 두 개 만드는 것보다, 한 프로세스 안에, 스레드를 한 개 더 만들어, 정적 영역 자원의 낭비를 줄일 수 있다. 이런 의미에서 스레드는 가벼운 프로세스라고 부른다.

---

1. **멀티스레드의 장단점**

`멀티스레드의 장점`

- 프로세스 내 공유가 가능한 부분을 제외하고 실행과 관련된 부분을 스레드로 나누어 관리하면 자원의 중복 사용을 피하면서 자원 사용의 효율성 + 작업의 효율성을 높일 수 있다.
- 응답성 향상
  - 한 스레드가 입출력으로 인해 작업이 진행되지 않더라도 다른 스레드가 작업을 계속하여 사용자의 작업 요구에 빨리 응답할 수 있음
- 자원 공유
  - 한 프로세스 내에서 독립적인 스레드를 생성하면 프로세스가 가진 자원을 모든 스레드가 공유하게 되어 작업을 원활하게 진행할 수 있다.
- 효율성 향상
  - 여러 개의 프로세스를 생성할 필요가 없어 불필요한 자원의 중복을 막을 수 있다.
- 다중 CPU 지원
  - 다중 CPU의 컴퓨터에서 멀티스레드를 사용하면 다중 CPU가 멀티스레드를 동시에 처리하여 CPU의 사용량이 증가하고 프로세스의 처리 시간이 단축된다.
- 비디오 플레이어 예시
  - 비디오 플레이어는 재생할 파일을 저장장치로부터 가져오는 부분(입출력 부분)과 가져온 데이터를 화면에 재생하는 부분으로 나뉜다.
  - 이를 단일 스레드로 구성하면 입출력을 요청한 작업이 끝나야, 화면을 재생할 수 있다.
  - 멀티스레드로 바꾸게 되면, 데이터를 받아옴과 동시에 재생을 할 수 있기 때문에, 즉각적으로 데이터 재생을 할 수 있게 되어 효율성이 올라 간다.

`멀티스레드의 단점`

- 인터넷 익스플로러와 크롬 브라우저의 차이
  - 인터넷 익스플로러는 하나의 프로세스에 멀티스레드를 이용하는 반면, 크롬 브라우저는 여러 프로세스를 사용한다.
  - 인터넷 익스플로러의 경우, 모든 스레드가 자원을 공유하기 때문에, 하나의 창에서 오류가 생기면 모든 창이 문제가 생긴다.
  - 크롬 브라우저의 경우 여러 개의 프로세스로 동작하기 때문에, 하나의 창이 문제가 생겨도, 다른 창은 독립적으로 돌아간다.
  - 최근에는 여러 개의 프로세스를 여러 개의 CPU에서 동시에 실행할 수 있어서, 크롬 브라우저는 낭비 요소가 있더라도 멀티스레드 대신 멀티태스킹을 이용한다.

---

1. **멀티스레드 모델**
- 스레드도 프로세스와 마찬가지로, 커널 스레드와 사용자 스레드로 나뉜다.

`사용자 스레드(1 to N 모델)`

- 특징
  - 커널이 멀티스레드를 지원하지 않을 때, 사용하는 방법으로, 초기 스레드 시스템에서 사용되었다.
  - 사용자 스레드는 사용자 레벨의 라이브러리에서 스레드를 구현한다.
  - 사용자 스레드 라이브러리는 커널이 지원하는 스케줄링이나 동기화 같은 기능을 대신 수행하여 스레드를 시행한다. 이는, 커널의 입장에서는 하나의 프로세스 작업처럼 보여준다.
  - 넷플릭스 아이디 공유 비유
    - 넷플릭스 아이디는 하나이지만, 여러 사용자가 공유하는 것처럼, 커널 입장에서 프로세스가 하나이지만, 사용자 자체적으로 여러 스레드를 만들어 구현한 것과 같다.
- 장점
  - 문맥 교환이 필요가 없어서 속도가 빠르다.
  - 사용자 레벨의 라이브러리가 작업을 관리하기 때문에, 커널 입장에서는 결국 동일한 프로세스가 계속 작동하고 있는 것이기 때문에, 프로세스의 변화가 일어나지 않아서 문맥 교환이 일어나지 않는 것이다.
- 단점
  - 여러 개의 사용자 스레드가 하나의 커널 스레드와 연결되기 때문에, 커널에서 관리하는 입출력이 발생하게 될 경우, 나머지 스레드들이 입출력이 완료될 때 가지 기다려야 한다.
  - 여러 개의 CPU를 동시에 사용할 수 없다.
    - 한 프로세스의 타임 슬라이스를 여러 스레드가 공유하기 때문에, 여러 개의 CPU를 동시에 사용할 수 없다.
    - CPU를 여러 개 갖추고, 멀티 스레드가 가능한 커널은 여러 CPU에 나누어 작업시키는 것이 가능하지만, 커널 입장에서 사용자 스레드는 하나의 프로세스로 인식되어 작업을 나눌 수가 없다.
  - 보안에 취약하다.
    - 커널 레벨에서는 공유 변수를 보호하는 장치가 있지만, 결국 사용자 레벨에서 라이브러리를 구현하기에 보안에 취약하다.

`커널 스레드(1 to 1 모델)`

- 특징
  - 커널이 멀티스레드를 지원하는 방식으로, 하나의 사용자 스레드가 하나의 커널 스레드와 연결되어 1 to 1 모델이라고 부른다.
  - 커널 스레드는 독립적으로 스케줄링되어, 대기 상태에 들어가도 다른 스레드는 작업을 계속할 수 있다. 또한, 커널이 제공하는 보호 기능 등의 모든 기능을 사용할 수 있다.
- 장점
  - 커널 레벨에서 모든 작업을 지원하여 멀티 CPU 사용 가능
  - 하나의 스레드가 대기 상태에 있어도, 다른 스레드는 작업이 가능하다.
  - 커널의 기능을 사용하기에 보안에 강하다.
- 단점
  - 문맥 교환 등에 있어서 오버헤드 때문에 느리게 작동한다.

`멀티레벨 스레드(M to N 모델)`

- 특징
  - 사용자 스레드와 커널 스레드를 혼합한 방식이다.
  - 사용자 스레드에서는 커널 스레드의 개수가 사용자 스레드보다 적기 때문에, 멀티레벨 스레드에서는 커널 스레드의 개수가 사용자 스레드보다 같거나 적다.
- 장점
  - 하나의 커널 스레드가 대기 상태에 들어가게 되면, 다른 커널 스레드가 대신 작업을 하여 사용자 스레드보다 유연하게 작업이 가능하다.
- 단점
  - 마찬가지로 문맥 교환시 오버헤드 발생으로 사용자 스레드 보다는 속도가 느리다.

→ 빠르게 움직여야 하는 스레드는 사용자 스레드로, 안정적으로 작동하는 스레드는 커널 스레드로 작동하게 한다.
