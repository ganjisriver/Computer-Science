# 02 CPU와 메모리

1. **CPU의 구성과 동작**

`CPU의 기본 구성`

- 산술 논리 연산장치(ALU, Arithmetic and Logic Unit)
  - CPU에서 데이터를 연산하는 장치가 산술논리 연산장치다.
  - 데이터의 덧셈, 뺄셈, 곱셈, 나눗셈 같은 산술 연산과 AND, OR 같은 논리 연산을 수행한다.
- 제어 장치
  - CPU에서 작업을 지시하는 부분
- 레지스터
  - CPU에서 사용할 데이터를 보관하는 저장 장치다.
  - 계산을 하기 위한 값을 저장하거나, 작업 중간에 필요한 정보를 저장하는 데에 사용한다.

`CPU의 명령어 처리 과정`

```cpp
// 코드 2-1
int D2 = 2; // D2 변수가 메모리 100번지에 저장된다고 가정
int D3 = 3; // D3 변수가 메모리 120번지에 저장된다고 가정
int sum; // sum 변수가 메모리 160번지에 저장된다고 가정 

sum = D2 + D3;
```

- 프로그래밍 언어에서 D2, D3, sum과 같이 변수를 선언하는 것은 메모리 내에 작업 공간을 만든다는 의미다.

- 메모리 내에 D2, D3, sum이 저장된 값들이 있지만, 프로그래밍에서 직접적으로 메모리 주소를 가리키기에는 작업 효율이 좋지 않기에, 메모리 주소의 ‘다른 이름’을 붙여준다.

- CPU는 0과 1의 2진수로 이루어진 기계어만 인식한다. 일반적으로 2진수의 기계어로 변환하기 전에, 사람이 읽기 어려운 기계어 대신 사람이 이해하기 쉬운 기호로 바꾼 어셈블리어로 변환이 된다. 아래는 어셈블리어의 예시다.

- 위의 2-1 코드 어셈블리어 예시

```nasm
// 2-2 코드
LOAD men(100), register 2 // 100번지의 D2 내용을 R2로 이동
LOAD men(120), register 3 // 120번지의 D3 내용을 R3로 이동 
ADD register 5, register 2, register 3 // R2와 R3를 더한 후에 R5에 임시저장
MOVE register 5, men(160) // R5 결과를 160번지(sum)에 저장
```

![CPU 작업과정.jpg](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/479c3c75-8458-4f10-a6e2-06724a5bf037/CPU_%EC%9E%91%EC%97%85%EA%B3%BC%EC%A0%95.jpg)

`레지스터의 종류`

CPU는 필요한 데이터를 메모리에서 가져와 레지스터에 저장하고 산술논리 연산장치를 이용하여 연산한 후, 그 결과를 다시 레지스터에 저장했다가 메모리로 옮긴다.

→ 이때 사용하는 레지스터가 데이터 레지스터와 주소 레지스터다. 이들은 사용자 프로그램에 의해 변경되기 때문에, **사용자 가시 레지스터**라고 부른다.

- `데이터 레지스터`
  - 메모리에서 가져온 데이터를 임시로 보관할 때 사용한다.
  - CPU에 있는 대부분의 레지스터를 데이터 레지스터로 구성한다. 그렇기 때문에, 일반 레지스터 또는 범용 레지스터라고 부른다.
- `주소 레지스터(AR, Address Register)`
  - 데이터 또는 명령어가 저장된 메모리의 주소는 주소 레지스터에 저장된다.

---

이러한 일반적인 레지스터말고 특별한 용도의 레지스터들이 있다. 이를 특수 레지스터라고 하고, 사용자가 임의로 변경할 수 없기 때문에, **사용자 불가시 레지스터**라고 한다.

<br>

- `프로그램 카운터(PC, Program Counter)`
  - CPU는 다음에 어떤 명령어를 처리해야 할지 알아야 한다.
  - 프로그램 카운터는 다음에 실행할 명령어의 주소를 제어 장치에 알려주는 역할을 한다.
- `명령어 레지스터(IR, Instruction Register)`
  - 현재 실행 중인 명령어를 저장한다. 제어 장치는 명령어 레지스터에 있는 명령어를 해석한 후, 외부 장치에 적절한 명령어를 전달한다.
- `메모리 주소 레지스터(MAR, Memory Address Register)`
  - 메모리에서 데이터를 가져오거나 반대로 메모리로 데이터를 보낼 때 주소를 지정하는 데 사용된다.
  - 명령어를 처리하는 과정에서 필요한 메모리 주소를 이 레지스터에 넣으면 메모리 관리자가 인식하여 해당 메모리 위치의 데이터를 가져오거나 해당 메모리 위치에 데이터를 저장한다.
- `메모리 버퍼 레지스터(MBR, Memory Buffer Register)`
  - 메모리에서 가져온 데이터나 메모리로 옮겨 갈 데이터를 임시로 저장한다. 메모리 버퍼 레지스터는 항상 메모리 주소 레지스터와 함께 동작한다.
- 특수 레지스터 작동 과정

![특수 레지스터 작업과정.jpg](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/72d74940-dfad-4a7a-8de4-2c5eab3806d1/%ED%8A%B9%EC%88%98_%EB%A0%88%EC%A7%80%EC%8A%A4%ED%84%B0_%EC%9E%91%EC%97%85%EA%B3%BC%EC%A0%95.jpg)

- 프로그램 카운터에는 실행해야 하는 코드의 행 번호(1)가 저장 되어 있다.
- 1이 제어 장치에 전송되면 1행이 실행되고 LOAD men(100), register 2가 실행되고, 명령어 레지스터(IR)에 LOAD가 탑재된다.
- 메모리 주소 레지스터에는 데이터 메모리 주소값 100이 저장된다.
- 메모리 버퍼 레지스터는 해당 메모리 값을 레지스터 2에 등록한다.

---

`버스의 종류`

시스템 버스는 CPU와 메모리, 주변 장치 간 데이터를 주고 받을 수 있게 해준다. 시스템 버스는 제어 버스, 주소 버스, 데이터 버스로 나뉜다.

- `제어 버스`
  - 메모리에 쓰기 신호를 보내거나, 읽기 신호를 보내는 등 메모리와 주변 장치에 명령 신호를 전달하는 역할을 한다.
  - 메모리에서 오류가 발생하거나 네트워크 카드에 데이터가 모두 도착했다는 신호 등이 제어 버스를 통해 CPU, 메모리, 주변 장치 등 양방향으로 전달 된다.
- `주소 버스`
  - 메모리의 데이터를 읽거나 쓸 때, 어느 위치에서 작업할 지 알려주는 정보가 오고 간다.
  - 메모리 주소 레지스터와 연결되어 있으며, 단방향이다. 즉, CPU에서 메모리나 주변장치로 나가는 주소 정보는 있지만, 주소 버스를 통해 주소 정보가 CPU로 전달되지는 않는다.
- `데이터 버스`
  - 제어 버스가 어떤 작업을 할 지 정하고, 주소 버스가 위치 정보를 전달해 주면, 데이터가 데이터 버스에 실려 목적지까지 이동한다. 데이터 버스는 메모리 버퍼 레지스터에 연결되어 있으며 양방향이다.

---

`CPU 비트의 의미`

버스의 대역폭

- 한 번에 전달할 수 있는 데이터의 최대 크기

- 흔히 말하는 32bit CPU, 64bit CPU 등은 한 번에 처리할 수 있는 데이터의 최대 크기로, 32bit의 의미는 메모리에서 데이터를 읽거나 쓸 때 한 번에 최대 32bit를 처리할 수 있다는 의미다.

- 이렇듯, CPU가 한꺼번에 처리할 수 있는 데이터의 최대 크기를 **워드(word)**라고 한다.
1. **메모리의 종류와 부팅**

`메모리의 종류`

- 메모리는 읽거나 쓸 수 있는 RAM과 읽기만 가능한 ROM으로 구분된다.

`RAM`

RAM은 전력이 끊기면 데이터가 사라지는 휘발성 메모리와 전력이 끊겨도 데이터가 유지 되는 비휘발성 메모리로 나뉜다.

- `휘발성 메모리`
  
  - **DRAM(동적 램)**
    - 저장된 0과 1의 데이터가 일정 시간이 지나면 사라지기 때문에, 재생이 필요하다는 의미다.
  - **SRAM(정적 램)**
    - 전력이 공급되는 동안에는 데이터를 보관할 수 있기 때문에, 재생할 필요가 없다.
    - 속도는 빠르지만, 가격이 비싸다.
  - 일반적인 메인메모리에는 DRAM을 사용하고, 캐시 등 고속 메모리에는 SRAM을 사용한다.
  - **SDRAM**
    - DRAM에서 발전된 형태로, 클록 틱(펄스)이 발생할 때마다 데이터를 저장하는 동기 DRAM이다.
    - DRAM과의 차이는 DRAM은 비동기식으로 작동하며, 주기적인 새로고침이 필요한 반면, SDRAM의 경우, 동기적으로 작동하며, 더 효율적이고, 대역폭이 더 넓다.
  - 메인 메모리를 비휘발성 메모리로 만들면, 전력이 끊겨도 내용이 남기 때문에, 편리할 수 있지만, 전력이 끊겨도 데이터를 보관하기 위해서는 메모리 내부가 복잡하고 속도가 느리며 가격이 비싸다.
  - **DDR SDRAM**
    - 위에서 설명한 것 처럼 SDRAM은 시스템 버스와 동기식으로 작동하기 때문에, 시스템 버스만큼의 느린 속도를 갖고 있다는 단점이 있다.
    - 이러한 단점을 보완하기 위해, DDR SDRAM은 SDRAM이 한 번에 1개의 데이터를 전송하지만, 이것은 2개의 데이터를 보낸다.
    - 이 DDR SDRAM은 계속 발전되어, DDR2, DDR3, 현재는 DDR4 SDRAM이 일반화되었다. 이는 옆에 붙은 숫자만큼 2를 곱한 속도만큼 빠르다. DDR4는 기존 DDR보다 2의4제곱정도 빠르다.

- `비휘발성 메모리`
  
  - **플래시 메모리**
    - 사용처
      - 디지털 카메라, MP3 플레이어, USB 드라이버 → 전력이 없어도 데이터를 보관하는 저장장치에 주로 사용
    - 단점
      - 플래시 메모리의 각 소자가 최대 사용 회수가 정해져 있다.
      - → SD 카드나 USB 드라이버를 오래 사용하면 성능이 저하되거나 데이터를 잃어버릴 수 있다는 단점이 있다.
  - FRAM
  - PRAM
  - SSD
    - SSD는 메모리보다는 하드디스크 대체품이다.
    - 가격이 비싸지만, 빠른 데이터 접근 속도, 저전력, 높은 내구성의 장점으로 많은 기기에서 사용된다.
  
  `ROM`
  
  - 램과 달리 ROM은 전력이 끊겨도 데이터를 보관할 수 있다는 것이 장점이지만, 데이터를 한 번 저장하면 바꿀 수 없다.
  - 롬의 종류에는 데이터를 지우거나 쓸 수 없는 마스크 롬, 전용 기계를 이용하여 데이터를 한 번만 저장할 수 있는 PROM 데이터를 여러 번 쓰고 지울 수 있는 EPROM 등이 있다.

---

`메모리 보호`

일괄 작업 시스템에서는 메모리가 운영체제 영역과 사용자 영역으로 구분 된다.

- 이 시스템 내에서의 메모리 보호는 사용자 영역이 운영체제 영역을 침범하지 못하게 막는 것이다.
- 최악의 경우 운영체제 영역을 침범하여 시스템이 멈출 수 있게 하는 악성 소프트웨어를 바이러스라고 한다.
- 운영체제도 CPU를 사용하는 소프트웨어 중 하나이기 때문에, 사용자 프로세스가 CPU를 차지했을 때, 운영체제의 작업도 잠시 멈추게 되고, 이 상태에서 운영체제 영역의 메모리 보호를 위해 `하드웨어의 도움`이 필요하다.

`CPU의 메모리 보호`

1. 메모리를 보호하기 위해 CPU는 현재 진행 중인 작업의 메모리 시작 주소를 **경계 레지스터**에 저장한 후 작업한다.
2. 현재 진행 중인 작업이 차지하고 있는 메모리의 크기를 **한계 레지스터**에 저장
3. 사용자 작업이 진행되는 동안 이 두 레지스터의 주소 범위를 벗어나는지 하드웨어 측면에서 점검함으로써, 메모리를 보호한다.
4. 사용자 프로세스 중 두 레지스터 값에서 벗어나는 경우 메모리 오류가 발생하는데, 이를 **인터럽트**라고 한다.
5. 인터럽트가 발생할 경우, 운영체제가 해당 프로그램을 강제 종료시켜 메모리를 보호한다.

`부팅`

Q. 응용 프로그램은 운영체제가 메모리에 올려 실행시킨다. 그렇다면, 운영체제는 누가 메모리에 올리는가?

→ 컴퓨터를 켰을 때, 운영체제를 메모리에 올리는 과정을 **부팅**이라고 한다.

- `부팅 과정`
  1. 컴퓨터를 켰을 때, 롬에 저장된 **바이오스**가 실행된다.
  2. 바이오스는 CPU, 메모리, 하드디스크, 키보드, 마우스와 같은 주요 하드웨어가 작동하는지 점검한다.
  3. 점검 완료 후, 바이오스는 하드디스크의 **마스터 부트 레코드**(MBR, Master Boot, Record)에 저장된 작은 프로그램을 메모리로 가져와 실행한다.
  4. MBR은 하드디스크의 첫 번째 섹터를 가르키고, 이는 운영체제를 실행하기 위한 **부트스트랩**이 저장되어 있다.
  5. 부트스트랩에 저장되어 있는 운영체제가 1개라면 자동으로 그 운영체제가 실행되고, 2개 이상이라면, 선택 화면이 나타나 선택 후 컴퓨터가 작동하게 된다.
